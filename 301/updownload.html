<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>

<body onload="getFileList()">
    <form onsubmit="uploadFiles()" id="fileSubmit">
        上传文件: <input type="file" multiple id="fileInput">
        <input type="submit" value="提交">
    </form>
    <br>
    <hr>
    <button onclick="getFileList()">刷新</button>
    <table id="fileList">
        <caption>文件列表</caption>
        <thead>
            <tr>
                <th>文件名</th>
                <th>文件大小(字节)</th>
                <th>文件修改时间</th>
            </tr>
        </thead>
        <tbody id="tbody">
            <!-- <tr>
                <td><a href="http://asciima.com">filenfsfame</a></td>
                <td>1024dddddddddddddddddd</td>
                <td>昨天</td>
            </tr> -->
        </tbody>

    </table>


    <!-- 脚本 -->
    <script>
        function getFileList(token) {
            // 检索
            token = sessionStorage.getItem("Authorization");
            console.log(token)
            var myHeaders = new Headers();
            myHeaders.append('Authorization', token);

            var myInit = {
                method: 'GET',
                headers: myHeaders,
            };

            var myRequest = new Request('/v1/files');

            fetch(myRequest, myInit)
                .then(fileListResponse)
                .then(load)
                .catch(e => console.log("Oops, error", e))

        }
        function fileListResponse(response) {
            if (401 === response.status) {
                newHost = window.location.host
                window.location.href = "http://" + newHost;
            }
            return response.json()
        }

        function load(listJSON) {
            var fileList = document.getElementById("tbody");
            var children = fileList.children;

            if (0 === listJSON.code) {
                for (i = children.length; i > 0; i--) {
                    fileList.removeChild(children[i - 1])
                }
                for (i in listJSON.data) {
                    var tr = document.createElement("tr"); "<tr>+"
                    var td = document.createElement("td");
                    var a = document.createElement("a");
                    a.innerHTML = listJSON.data[i].Name;
                    var attr = document.createAttribute("href");
                    attr.nodeValue = "http://" + window.location.host + "/v1/files/" + listJSON.data[i].Name;
                    a.attributes.setNamedItem(attr);
                    td.appendChild(a)
                    tr.appendChild(td);
                    var tdSize = document.createElement("td");
                    tdSize.innerHTML = listJSON.data[i].Size
                    tr.appendChild(tdSize);
                    var tdTime = document.createElement("td");
                    tdTime.innerHTML = listJSON.data[i].ModTime;
                    tr.appendChild(tdTime);

                    fileList.appendChild(tr);
                }

            } else {
                alert("wrong------------------!" + listJSON.message)
            }

        }

        function uploadFiles() {
            event.preventDefault()
            var fileInput = document.forms["fileSubmit"]["fileInput"]
            var files = fileInput.files
            console.log("lengthis: " + files.length);
            if (files.length < 1) {
                alert("non file selected!!!!!!");
                return;
            }

            // 检索
            token = sessionStorage.getItem("Authorization");
            console.log(token)
            var myHeaders = new Headers();
            myHeaders.append('Authorization', token);
            myHeaders.append('Content-Type', "application/octet-stream");

            var myInit = {
                method: 'POST',
                headers: myHeaders,
            };


            for (let i = 0; i < files.length; i++) {
                console.log("i is: " + i);
                console.log(files[i].name);
                console.log(files[i].size);
                console.log(files[i].type);

                let reader = new FileReader();
                let uri = "/v1/files/" + files[i].name
                let myRequest = new Request(uri);
                reader.onload = function (evt) {
                    myInit.body = reader.result;

                    fetch(myRequest, myInit)
                        .then(fileListResponse)
                        .then(resJSON => console.log(resJSON))
                        .catch(e => console.log("Oops, error", e))
                };
                reader.readAsBinaryString(files[i])
            }



        }
    </script>
</body>

</html>